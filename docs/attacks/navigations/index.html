<!doctype html><html lang=en dir=ZgotmplZ><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Detecting if a cross-site page triggered a navigation (or didn&rsquo;t) can be useful to an attacker. For example, a website may trigger a navigation in a certain endpoint depending on the status of the user.
To detect if any kind of navigation occurred, an attacker can:

Use an iframe and count the number of times the onload event is triggered.
Check the value of history.length, which is accessible through any window reference. This provides the number of entries in the history of a victim that were either changed by history.pushState or by regular navigations. To get the value of history.length, an attacker changes the location of the window reference to the target website, then changes back to same-origin, and finally reads the value. Run demo


  Download Trigger
  #

When an endpoint sets the Content-Disposition: attachment header, it instructs the browser to download the response as an attachment instead of navigating to it. Detecting if this behavior occurred might allow attackers to leak private information if the outcome depends on the state of the victim&rsquo;s account."><meta name=theme-color content="#FFFFFF"><meta property="og:url" content="https://xsleaks.dev/docs/attacks/navigations/"><meta property="og:site_name" content="XS-Leaks Wiki"><meta property="og:title" content="Navigations"><meta property="og:description" content="Detecting if a cross-site page triggered a navigation (or didn’t) can be useful to an attacker. For example, a website may trigger a navigation in a certain endpoint depending on the status of the user.
To detect if any kind of navigation occurred, an attacker can:
Use an iframe and count the number of times the onload event is triggered. Check the value of history.length, which is accessible through any window reference. This provides the number of entries in the history of a victim that were either changed by history.pushState or by regular navigations. To get the value of history.length, an attacker changes the location of the window reference to the target website, then changes back to same-origin, and finally reads the value. Run demo Download Trigger # When an endpoint sets the Content-Disposition: attachment header, it instructs the browser to download the response as an attachment instead of navigating to it. Detecting if this behavior occurred might allow attackers to leak private information if the outcome depends on the state of the victim’s account."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-06T23:25:01+02:00"><title>Navigations | XS-Leaks Wiki</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.1c9a9009be3c645cbccbe64eb0a90e28621e4118971d9a502db4aaa9bec96cfc.css integrity="sha256-HJqQCb48ZFy8y+ZOsKkOKGIeQRiXHZpQLbSqqb7JbPw="><script defer src=/en.search.min.4b0a0e5c472b82ce2e0b8fb53b12f2357a995b4df3e5361e577dddec4f0aa8b4.js integrity="sha256-SwoOXEcrgs4uC4+1OxLyNXqZW03z5TYeV33d7E8KqLQ="></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk="></script></head><body dir=ZgotmplZ><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>XS-Leaks Wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Attacks</span><ul><li><a href=/docs/attacks/xs-search/>XS-Search</a></li><li><a href=/docs/attacks/window-references/>Window References</a></li><li><a href=/docs/attacks/css-tricks/>CSS Tricks</a></li><li><a href=/docs/attacks/error-events/>Error Events</a></li><li><a href=/docs/attacks/frame-counting/>Frame Counting</a></li><li><a href=/docs/attacks/navigations/ class=active>Navigations</a></li><li><a href=/docs/attacks/cache-probing/>Cache Probing</a></li><li><a href=/docs/attacks/element-leaks/>Element leaks</a></li><li><a href=/docs/attacks/id-attribute/>ID Attribute</a></li><li><a href=/docs/attacks/postmessage-broadcasts/>postMessage Broadcasts</a></li><li><span>Browser Features</span><ul><li><a href=/docs/attacks/browser-features/corb/>CORB Leaks</a></li><li><a href=/docs/attacks/browser-features/corp/>CORP Leaks</a></li></ul></li><li><span>Timing Attacks</span><ul><li><a href=/docs/attacks/timing-attacks/clocks/>Clocks</a></li><li><a href=/docs/attacks/timing-attacks/network-timing/>Network Timing</a></li><li><a href=/docs/attacks/timing-attacks/performance-api/>Performance API</a></li><li><a href=/docs/attacks/timing-attacks/execution-timing/>Execution Timing</a></li><li><a href=/docs/attacks/timing-attacks/hybrid-timing/>Hybrid Timing</a></li><li><a href=/docs/attacks/timing-attacks/connection-pool/>Connection Pool</a></li></ul></li><li><a href=/docs/attacks/experiments/ class=collapsed>Experiments</a></li><li><a href=/docs/attacks/css-injection/>CSS Injection</a></li><li><a href=/docs/attacks/historical/ class=collapsed>Historical</a></li></ul></li><li class=book-section-flat><a href=/docs/defenses/>Defense Mechanisms</a><ul><li><a href=/docs/defenses/design-protections/>Application Design</a><ul><li><a href=/docs/defenses/design-protections/cache-protections/>Cache Protections</a></li><li><a href=/docs/defenses/design-protections/subresource-protections/>Subresource Protections</a></li></ul></li><li><a href=/docs/defenses/opt-in/>Opt-In Mechanisms</a><ul><li><a href=/docs/defenses/opt-in/fetch-metadata/>Fetch Metadata</a></li><li><a href=/docs/defenses/opt-in/coop/>Cross-Origin-Opener-Policy</a></li><li><a href=/docs/defenses/opt-in/corp/>Cross-Origin-Resource-Policy</a></li><li><a href=/docs/defenses/opt-in/xfo/>Framing Protections</a></li><li><a href=/docs/defenses/opt-in/same-site-cookies/>SameSite Cookies</a></li><li><a href=/docs/defenses/opt-in/document-policies/>Document Policies</a></li></ul></li><li><a href=/docs/defenses/isolation-policies/>Isolation Policies</a><ul><li><a href=/docs/defenses/isolation-policies/resource-isolation/>Resource Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/framing-isolation/>Framing Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/navigation-isolation/>Navigation Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/strict-isolation/>Strict Isolation Policy</a></li></ul></li><li><a href=/docs/defenses/secure-defaults/>Secure Defaults</a><ul><li><a href=/docs/defenses/secure-defaults/corb/>Cross-Origin Read Blocking</a></li><li><a href=/docs/defenses/secure-defaults/partitioned-cache/>Partitioned HTTP Cache</a></li></ul></li></ul></li><li class=book-section-flat><a href=/docs/contributions/>Contributions</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Navigations</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#download-trigger>Download Trigger</a><ul><li><a href=#download-navigation-with-iframes>Download Navigation (with iframes)</a></li><li><a href=#download-navigation-without-iframes>Download Navigation (without iframes)</a></li></ul></li><li><a href=#server-side-redirects>Server-Side Redirects</a><ul><li><a href=#max-redirects>Max redirects</a></li><li><a href=#inflation-server-side-errors>Inflation (Server-Side Errors)</a></li><li><a href=#inflation-client-side-errors>Inflation (Client-Side Errors)</a></li></ul></li><li><a href=#cross-origin-redirects>Cross-Origin Redirects</a><ul><li><a href=#csp-violations>CSP Violations</a></li></ul></li><li><a href=#case-scenarios>Case Scenarios</a></li><li><a href=#partitioned-http-cache-bypass>Partitioned HTTP Cache Bypass</a></li><li><a href=#defense>Defense</a></li><li><a href=#real-world-examples>Real-World Examples</a></li><li><a href=#references>References</a></li></ul></nav></aside></header><article class=markdown><h1>Navigations</h1><h5>October 1, 2020</h5><p><p>Detecting if a cross-site page triggered a navigation (or didn&rsquo;t) can be useful to an attacker. For example, a website may trigger a navigation in a certain endpoint <a href=#case-scenarios>depending on the status of the user</a>.</p><p>To detect if any kind of navigation occurred, an attacker can:</p><ul><li>Use an <code>iframe</code> and count the number of times the <code>onload</code> event is triggered.</li><li>Check the value of <code>history.length</code>, which is accessible through any window reference. This provides the number of entries in the history of a victim that were either changed by <code>history.pushState</code> or by regular navigations. To get the value of <code>history.length</code>, an attacker changes the location of the window reference to the target website, then changes back to same-origin, and finally reads the value. <a href=https://xsinator.com/testing.html#History%20Length%20Leak>Run demo</a></li></ul><h2 id=download-trigger>Download Trigger
<a class=anchor href=#download-trigger>#</a></h2><p>When an endpoint sets the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition><code>Content-Disposition: attachment</code></a> header, it instructs the browser to download the response as an attachment instead of navigating to it. Detecting if this behavior occurred might allow attackers to leak private information if the outcome depends on the state of the victim&rsquo;s account.</p><h3 id=download-navigation-with-iframes>Download Navigation (with iframes)
<a class=anchor href=#download-navigation-with-iframes>#</a></h3><p>Another way to test for the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition><code>Content-Disposition: attachment</code></a> header is to check if a navigation occurred. If a page load causes a download, it does not trigger a navigation and the window stays within the same origin. <a href=https://xsinator.com/testing.html#Download%20Detection>Run demo</a></p><p>In the snippet below , we&rsquo;ve added a sandboxed iframe with downloads disabled to prevent a download modal from appearing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6272a4>// Set the destination URL to test for the download attempt
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;https://example.org/&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#6272a4>// Create an outer iframe to measure onload event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> iframe <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>document</span>.createElement(<span style=color:#f1fa8c>&#39;iframe&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#6272a4>// Don&#39;t actually download the file to be stealthy
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>iframe.sandbox <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;allow-scripts allow-same-origin allow-popups&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>document</span>.body.appendChild(iframe);
</span></span><span style=display:flex><span><span style=color:#6272a4>// Create an inner iframe to test for the download attempt
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>iframe.srcdoc <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`&lt;iframe src=&#34;</span><span style=color:#f1fa8c>${</span>url<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34; &gt;&lt;/iframe&gt;`</span>;
</span></span><span style=display:flex><span>iframe.onload <span style=color:#ff79c6>=</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#6272a4>// If a navigation occurs, the iframe will be cross-origin,
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>          <span style=color:#6272a4>// so accessing &#34;inner.origin&#34; will throw an exception
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>          iframe.contentWindow.frames[<span style=color:#bd93f9>0</span>].origin;
</span></span><span style=display:flex><span>          console.log(<span style=color:#f1fa8c>&#39;Download attempt detected&#39;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#ff79c6>catch</span>(e) {
</span></span><span style=display:flex><span>          console.log(<span style=color:#f1fa8c>&#39;No download attempt detected&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote class="book-hint2 info"><p class="hint-title info"><svg class="book-icon"><use href="/svg/hint-icons.svg#info-notice"/></svg><span>info</span></p>When there is no navigation inside an <code>iframe</code> caused by a download attempt, the <code>iframe</code> does not trigger an <code>onload</code> event directly. For this reason, in the example above, an outer <code>iframe</code> was used instead, which listens for an <code>onload</code> event which triggers when subresources finish loading, including <code>iframe</code>s.</blockquote><blockquote class="book-hint2 important"><p class="hint-title important"><svg class="book-icon"><use href="/svg/hint-icons.svg#important-notice"/></svg><span>important</span></p>This attack works regardless of any <a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a>, because the <code>X-Frame-Options</code> and <code>Content-Security-Policy</code> headers are ignored if <code>Content-Disposition: attachment</code> is specified.</blockquote><h3 id=download-navigation-without-iframes>Download Navigation (without iframes)
<a class=anchor href=#download-navigation-without-iframes>#</a></h3><p>A variation of the technique presented in the previous section can also be effectively tested using <code>window</code> objects. In the snippet below, we&rsquo;ve added a sandboxed iframe with disabled downloads to prevent a download modal from appearing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6272a4>// Set the destination URL
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;https://example.org&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Don&#39;t actually download the file to be stealthy
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> iframe <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>document</span>.createElement(<span style=color:#f1fa8c>&#39;iframe&#39;</span>);
</span></span><span style=display:flex><span>iframe.sandbox <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;allow-scripts allow-same-origin allow-popups&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>document</span>.body.appendChild(iframe);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Get a window reference
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> win <span style=color:#ff79c6>=</span> iframe.contentWindow.open(url);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Wait for the window to load.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>setTimeout(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#6272a4>// If a navigation occurs, the iframe will be cross-origin,
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>          <span style=color:#6272a4>// so accessing &#34;win.origin&#34; will throw an exception
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>          win.origin;
</span></span><span style=display:flex><span>          parent.console.log(<span style=color:#f1fa8c>&#39;Download attempt detected&#39;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#ff79c6>catch</span>(e) {
</span></span><span style=display:flex><span>          parent.console.log(<span style=color:#f1fa8c>&#39;No download attempt detected&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>}, <span style=color:#bd93f9>2000</span>);
</span></span></code></pre></div><h2 id=server-side-redirects>Server-Side Redirects
<a class=anchor href=#server-side-redirects>#</a></h2><h3 id=max-redirects>Max redirects
<a class=anchor href=#max-redirects>#</a></h3><p>When a page initiates a chain of 3XX redirects, browsers limit the maximum number of redirects to 20 <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. This can be used to detect the exact number of redirects occurred for a cross-origin page by following the below approach <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><ol><li>As a malicious website, initiate 19 redirects and make the final 20th redirect to the attacked page.</li><li>If the browser threw a network error, at least one redirect occurred. Repeat the process with 18 redirects.</li><li>If the browser didn&rsquo;t threw a network error, the number of redirects is known as <code>20 - issued_redirects</code>.</li></ol><p><em>To detect an error one can use <a href=https://xsleaks.dev/docs/attacks/error-events/>Error Events</a></em></p><p>If performed in a top window, this also works with SameSite lax cookies and other cross-site protections, such as <a href=https://xsleaks.dev/docs/defenses/isolation-policies/framing-isolation/>Framing Isolation Policy</a> or <a href=https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/>Resource Isolation Policy</a>. <a href=https://xsinator.com/testing.html#Max%20Redirect%20Leak>Run demo</a></p><h3 id=inflation-server-side-errors>Inflation (Server-Side Errors)
<a class=anchor href=#inflation-server-side-errors>#</a></h3><p>A server-side redirect can be detected from a cross-origin page if the destination URL increases in size and contains an attacker-controlled input (either in the form of a query string parameter or a path). The following technique relies on the fact that it is possible to induce an error in most web-servers by generating large request parameters/paths. Since the redirect increases the size of the URL, it can be detected by sending exactly one character less than the server&rsquo;s maximum capacity. That way, if the size increases, the server will respond with an error that can be detected from a cross-origin page (e.g. via Error Events).</p><blockquote class="book-hint2 example"><p class="hint-title example"><svg class="book-icon"><use href="/svg/hint-icons.svg#example-notice"/></svg><span>example</span></p>An example of this attack can be seen <a href=https://xsleaks.github.io/xsleaks/examples/redirect/>here</a>.</blockquote><h3 id=inflation-client-side-errors>Inflation (Client-Side Errors)
<a class=anchor href=#inflation-client-side-errors>#</a></h3><p>Most browsers have a maximum permitted URL length, above which the navigation will be aborted. For example, Chrome limits URLs to a maximum length of 2MB <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. When this limit is exceeded, the browser may exhibit behavior that can be detected from a cross-origin page. The exact URL length limit and oracle behavior depends on the browser.</p><p>When requesting a URL with a fragment, the fragment is preserved on server redirects. For example, if <code>//example.org</code> redirects to <code>//example.org/redirected</code>, the browser will navigate to <code>//example.org/redirected#fragment</code> when <code>//example.org#fragment</code> is requested. This allows an attacker to artificially inflate the URL length by adding a large fragment to the URL so that it is exactly one character less than the maximum permitted length.</p><blockquote class="book-hint2 example"><p class="hint-title example"><svg class="book-icon"><use href="/svg/hint-icons.svg#example-notice"/></svg><span>example</span></p>Chrome will navigate to an <code>about:blank</code> page if the URL length is exceeded. An attacker can detect whether a redirect occurred by checking if the page is still on the same origin.</blockquote><h2 id=cross-origin-redirects>Cross-Origin Redirects
<a class=anchor href=#cross-origin-redirects>#</a></h2><h3 id=csp-violations>CSP Violations
<a class=anchor href=#csp-violations>#</a></h3><p><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>Content-Security-Policy</a> (CSP) is an in-depth defense mechanism against XSS and data injection attacks. When a CSP is violated, a <code>SecurityPolicyViolationEvent</code> is thrown. An attacker can set up a CSP using the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/connect-src><code>connect-src</code> directive</a> which triggers a <code>Violation</code> event every time a <code>fetch</code> follows an URL not set in the CSP directive. This allows an attacker to detect if a redirect to another origin occurred <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. <a href=https://xsinator.com/testing.html#CSP%20Violation%20Leak>Run demo</a></p><p>The example below triggers a <code>SecurityPolicyViolationEvent</code> if the website set in the fetch API (line 6) redirects to a website other than <code>https://example.org</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#6272a4>&lt;!-- Set the Content-Security-Policy to only allow example.org --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>meta</span> <span style=color:#50fa7b>http-equiv</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Content-Security-Policy&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>content</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;connect-src https://example.org&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>script</span>&gt;
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listen for a CSP violation event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>document</span>.addEventListener(<span style=color:#f1fa8c>&#39;securitypolicyviolation&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  console.log(<span style=color:#f1fa8c>&#34;Detected a redirect to somewhere other than example.org&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#6272a4>// Try to fetch example.org. If it redirects to another cross-site website
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// it will trigger a CSP violation event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>fetch(<span style=color:#f1fa8c>&#39;https://example.org/might_redirect&#39;</span>, {
</span></span><span style=display:flex><span>  mode<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;no-cors&#39;</span>,
</span></span><span style=display:flex><span>  credentials<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;include&#39;</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>&lt;/<span style=color:#ff79c6>script</span>&gt;</span></span></code></pre></td></tr></table></div></div><p>When the redirect of interest is cross-site and conditioned on the presence of a cookie marked <code>SameSite=Lax</code>, the approach outlined above won&rsquo;t work, because <code>fetch</code> doesn&rsquo;t count as a top-level navigation. In a case like this, the attacker can use another CSP directive, <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/form-action><code>form-action</code></a>, and leverage the fact that submitting a HTML form using <code>GET</code> as its method does count as a top-level navigation.</p><p>The example below triggers a <code>SecurityPolicyViolationEvent</code> if the form&rsquo;s action (line 3) redirects to a website other than <code>https://example.org</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#6272a4>&lt;!-- Set the Content-Security-Policy to only allow example.org --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>meta</span> <span style=color:#50fa7b>http-equiv</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Content-Security-Policy&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>content</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;form-action https://example.org&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>form</span> <span style=color:#50fa7b>action</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;https://example.org/might_redirect&#34;</span>&gt;&lt;/<span style=color:#ff79c6>form</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>script</span>&gt;
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listen for a CSP violation event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>document</span>.addEventListener(<span style=color:#f1fa8c>&#39;securitypolicyviolation&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  console.log(<span style=color:#f1fa8c>&#34;Detected a redirect to somewhere other than example.org&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#6272a4>// Try to get example.org via a form. If it redirects to another cross-site website
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// it will trigger a CSP violation event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>document</span>.forms[<span style=color:#bd93f9>0</span>].submit();
</span></span><span style=display:flex><span>&lt;/<span style=color:#ff79c6>script</span>&gt;</span></span></code></pre></td></tr></table></div></div><p>Note that this approach is unviable in Firefox (contrary to Chromium-based browsers) because <code>form-action</code> doesn&rsquo;t block redirects after a form submission in that browser.</p><h2 id=case-scenarios>Case Scenarios
<a class=anchor href=#case-scenarios>#</a></h2><p>An online bank decides to redirect wealthy users to attractive stock opportunities by triggering a navigation to a reserved space on the website when these users consult their account balance. If this is only done for a specific group of users, it becomes possible for an attacker to leak the &ldquo;client status&rdquo; of the user.</p><h2 id=partitioned-http-cache-bypass>Partitioned HTTP Cache Bypass
<a class=anchor href=#partitioned-http-cache-bypass>#</a></h2><p>If a site <code>example.com</code> includes a resource from <code>*.example.com/resource</code> then that resource will have the same caching key as if the resource was directly requested through top-level navigation. That is because the caching key is consisted of top-level <em>eTLD+1</em> and frame <em>eTLD+1</em>. <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></p><p>Because a window can prevent a navigation to a different origin with <code>window.stop()</code> and the on-device cache is faster than the network,
it can detect if a resource is cached by checking if the origin changed before the <code>stop()</code> could be run.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> ifCached_window(url) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Promise</span>(resolve =&gt; {
</span></span><span style=display:flex><span>    checker.location <span style=color:#ff79c6>=</span> url;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Cache only
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    setTimeout(() =&gt; {
</span></span><span style=display:flex><span>      checker.stop();
</span></span><span style=display:flex><span>    }, <span style=color:#bd93f9>20</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Get result
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    setTimeout(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>let</span> origin <span style=color:#ff79c6>=</span> checker.origin;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Origin has not changed before timeout.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        resolve(<span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>      } <span style=color:#ff79c6>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Origin has changed.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        resolve(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        checker.location <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;about:blank&#34;</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#bd93f9>50</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Create window (makes it possible to go back after a successful check)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>let</span> checker <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>window</span>.open(<span style=color:#f1fa8c>&#34;about:blank&#34;</span>);
</span></span></code></pre></div><p>Usage</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff79c6>await</span> ifCached_window(<span style=color:#f1fa8c>&#34;https://example.org&#34;</span>);
</span></span></code></pre></div><blockquote class="book-hint2 info"><p class="hint-title info"><svg class="book-icon"><use href="/svg/hint-icons.svg#info-notice"/></svg><span>info</span></p>Partitioned HTTP Cache Bypass can be prevented using the header <code>Vary: Sec-Fetch-Site</code> as that splits the cache by its initiator, see <a href=https://xsleaks.dev/docs/defenses/design-protections/cache-protections/>Cache Protections</a>. It works because the attack only applies for the resources from the same site, hence <code>Sec-Fetch-Site</code> header will be <code>cross-site</code> for the attacker compared to <code>same-site</code> or <code>same-origin</code> for the website.</blockquote><h2 id=defense>Defense
<a class=anchor href=#defense>#</a></h2><table><thead><tr><th style=text-align:center>Attack Alternative</th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/same-site-cookies/>SameSite Cookies (Lax)</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/coop/>COOP</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/>Isolation Policies</a></th></tr></thead><tbody><tr><td style=text-align:center><em>history.length</em> (iframes)</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>✔️</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/framing-isolation/>FIP</a></td></tr><tr><td style=text-align:center><em>history.length</em> (windows)</td><td style=text-align:center>❌</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center><em>onload</em> event inside an iframe</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>✔️</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/framing-isolation/>FIP</a></td></tr><tr><td style=text-align:center>Download bar</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>❌
<link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><span>\(^{1}\)</span></td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>Download Navigation (iframes)</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>❌<span>
\(^{1}\)</span></td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/framing-isolation/>FIP</a></td></tr><tr><td style=text-align:center>Download Navigation (windows)</td><td style=text-align:center>❌</td><td style=text-align:center>❌<span>
\(^{1}\)</span></td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>Inflation (Server-Side Errors)</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/>RIP</a></td></tr><tr><td style=text-align:center>Inflation (Client-Side Errors)</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>CSP Violations</td><td style=text-align:center>❌<span>
\(^{2}\)</span></td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/>RIP</a> 🔗 <a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr></tbody></table><p>🔗 – Defense mechanisms must be combined to be effective against different scenarios.</p><hr><ol><li>Neither <a href=https://xsleaks.dev/docs/defenses/opt-in/coop/>COOP</a> nor <a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a> helps with the mitigation of the redirect leaks because when the header <code>Content-Disposition</code> is present, other headers are being ignored.</li><li>SameSite cookies in Lax mode could protect against iframing a website, but won&rsquo;t help with the leaks through window references or involving server-side redirects, in contrast to Strict mode.</li></ol><h2 id=real-world-examples>Real-World Examples
<a class=anchor href=#real-world-examples>#</a></h2><p>A vulnerability reported to Twitter used this technique to leak the contents of private tweets using <a href=https://xsleaks.dev/docs/attacks/xs-search/>XS-Search</a>. This attack was possible because the page would only trigger a navigation if there were results to the user query <sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>.</p><h2 id=references>References
<a class=anchor href=#references>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>HTTP-redirect fetch, <a href=https://fetch.spec.whatwg.org/#http-redirect-fetch>link</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>XS-Leaks in redirect flows, <a href=https://docs.google.com/presentation/d/1rlnxXUYHY9CHgCMckZsCGH4VopLo4DYMvAcOltma0og>link</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Chromium Docs - Guidelines for URL Display, <a href=https://chromium.googlesource.com/chromium/src/+/main/docs/security/url_display_guidelines/url_display_guidelines.md>link</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Disclose domain of redirect destination taking advantage of CSP, <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=313737">link</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Using Content-Security-Policy for Evil, <a href=http://homakov.blogspot.com/2014/01/using-content-security-policy-for-evil.html>link</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/xsleaks/wiki/pull/106>github.com/xsleaks/wiki/pull/106</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p>Protected tweets exposure through the url, <a href=https://hackerone.com/reports/491473>link</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/commit/f733803404794a4473bc6c218d9df21e5ae8d7aa title='Last modified by terjanq | July 6, 2024' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Last Modified: July 6, 2024</span></a></div><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/edit/master/content/docs/attacks/navigations.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this article</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#download-trigger>Download Trigger</a><ul><li><a href=#download-navigation-with-iframes>Download Navigation (with iframes)</a></li><li><a href=#download-navigation-without-iframes>Download Navigation (without iframes)</a></li></ul></li><li><a href=#server-side-redirects>Server-Side Redirects</a><ul><li><a href=#max-redirects>Max redirects</a></li><li><a href=#inflation-server-side-errors>Inflation (Server-Side Errors)</a></li><li><a href=#inflation-client-side-errors>Inflation (Client-Side Errors)</a></li></ul></li><li><a href=#cross-origin-redirects>Cross-Origin Redirects</a><ul><li><a href=#csp-violations>CSP Violations</a></li></ul></li><li><a href=#case-scenarios>Case Scenarios</a></li><li><a href=#partitioned-http-cache-bypass>Partitioned HTTP Cache Bypass</a></li><li><a href=#defense>Defense</a></li><li><a href=#real-world-examples>Real-World Examples</a></li><li><a href=#references>References</a></li></ul></nav></aside></main></body></html>